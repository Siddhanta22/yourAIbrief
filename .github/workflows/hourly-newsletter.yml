name: Hourly Newsletter Delivery

on:
  schedule:
    # Run every hour at :00 minutes (e.g., 1:00, 2:00, 3:00, etc.)
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  trigger-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Check Secrets
        run: |
          # Support both naming conventions
          VERCEL_URL_VALUE="${{ secrets.VERCEL_URL || secrets.VERCEL }}"
          CRON_SECRET_VALUE="${{ secrets.CRON_SECRET || secrets.CRON }}"
          
          if [ -z "$VERCEL_URL_VALUE" ]; then
            echo "‚ùå Error: VERCEL_URL or VERCEL secret is not set"
            echo "Please add VERCEL_URL (or VERCEL) to GitHub Secrets (Settings ‚Üí Secrets and variables ‚Üí Actions)"
            exit 1
          fi
          if [ -z "$CRON_SECRET_VALUE" ]; then
            echo "‚ùå Error: CRON_SECRET or CRON secret is not set"
            echo "Please add CRON_SECRET (or CRON) to GitHub Secrets (Settings ‚Üí Secrets and variables ‚Üí Actions)"
            exit 1
          fi
          echo "‚úÖ Secrets are configured"
        
      - name: Trigger Newsletter Cron
        run: |
          # Support both naming conventions
          VERCEL_URL="${{ secrets.VERCEL_URL || secrets.VERCEL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET || secrets.CRON }}"
          
          # Remove trailing slash if present
          VERCEL_URL="${VERCEL_URL%/}"
          
          echo "üîî Triggering newsletter cron at: ${VERCEL_URL}/api/cron/send"
          
          # Make the request and capture both response code and body
          HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${VERCEL_URL}/api/cron/send?key=${CRON_SECRET}&source=github-actions" \
            -H "User-Agent: GitHub-Actions" \
            -H "X-Cron-Source: github-actions" \
            --max-time 60)
          
          echo "üìä Response code: ${HTTP_CODE}"
          
          if [ -f /tmp/response.txt ]; then
            echo "üìÑ Response body:"
            cat /tmp/response.txt
            echo ""
          fi
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Newsletter cron triggered successfully"
            exit 0
          elif [ "$HTTP_CODE" -eq 0 ]; then
            echo "‚ùå Error: Failed to connect to ${VERCEL_URL}"
            echo "Please verify VERCEL_URL is correct and the site is deployed"
            exit 1
          else
            echo "‚ùå Newsletter cron failed with HTTP status: ${HTTP_CODE}"
            exit 1
          fi


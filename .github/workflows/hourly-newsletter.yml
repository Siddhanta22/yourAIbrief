name: Hourly Newsletter Delivery

on:
  schedule:
    # Run every hour at :00 minutes (e.g., 1:00, 2:00, 3:00, etc.)
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  trigger-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Check Secrets
        run: |
          # Support both naming conventions
          VERCEL_URL_VALUE="${{ secrets.VERCEL_URL || secrets.VERCEL }}"
          CRON_SECRET_VALUE="${{ secrets.CRON_SECRET || secrets.CRON }}"
          
          if [ -z "$VERCEL_URL_VALUE" ]; then
            echo "âŒ Error: VERCEL_URL or VERCEL secret is not set"
            echo "Please add VERCEL_URL (or VERCEL) to GitHub Secrets (Settings â†’ Secrets and variables â†’ Actions)"
            exit 1
          fi
          if [ -z "$CRON_SECRET_VALUE" ]; then
            echo "âŒ Error: CRON_SECRET or CRON secret is not set"
            echo "Please add CRON_SECRET (or CRON) to GitHub Secrets (Settings â†’ Secrets and variables â†’ Actions)"
            exit 1
          fi
          echo "âœ… Secrets are configured"
        
      - name: Trigger Newsletter Cron
        run: |
          # Support both naming conventions
          VERCEL_URL="${{ secrets.VERCEL_URL || secrets.VERCEL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET || secrets.CRON }}"
          VERCEL_BYPASS_TOKEN="${{ secrets.VERCEL_BYPASS_TOKEN || secrets.BYPASS || '' }}"
          
          # Remove trailing slash if present
          VERCEL_URL="${VERCEL_URL%/}"
          
          # Ensure URL starts with https://
          if [[ ! "$VERCEL_URL" =~ ^https?:// ]]; then
            VERCEL_URL="https://${VERCEL_URL}"
          fi
          
          echo "ğŸ”” Triggering newsletter cron at: ${VERCEL_URL}/api/cron/send"
          echo "ğŸ”‘ Using CRON secret: ${CRON_SECRET:0:4}**** (first 4 chars shown)"
          
          # Build query string with bypass token if available
          # Use printf for URL encoding (more reliable than custom function)
          urlencode() {
            local string="${1}"
            local encoded=""
            local i=0
            while [ $i -lt ${#string} ]; do
              local char="${string:$i:1}"
              case "$char" in
                [a-zA-Z0-9.~_-])
                  encoded+="$char"
                  ;;
                *)
                  printf -v encoded "%s%%%02x" "$encoded" "'$char"
                  ;;
              esac
              ((i++))
            done
            echo -n "$encoded"
          }
          
          # Encode the secrets
          CRON_SECRET_ENCODED=$(urlencode "${CRON_SECRET}")
          QUERY="key=${CRON_SECRET_ENCODED}&source=github-actions"
          if [ -n "${VERCEL_BYPASS_TOKEN}" ]; then
            BYPASS_TOKEN_ENCODED=$(urlencode "${VERCEL_BYPASS_TOKEN}")
            QUERY="${QUERY}&x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${BYPASS_TOKEN_ENCODED}"
            echo "ğŸ”“ Using Vercel protection bypass token"
          else
            echo "âš ï¸  No VERCEL_BYPASS_TOKEN found - if you get 401 errors, add bypass token to GitHub Secrets"
          fi
          
          # Construct the full URL
          BASE_URL="${VERCEL_URL}/api/cron/send"
          FULL_URL="${BASE_URL}?${QUERY}"
          
          echo "ğŸŒ Base URL: ${BASE_URL}"
          echo "ğŸ”— Query string length: ${#QUERY} characters"
          
          # Validate URL format
          if [[ ! "${BASE_URL}" =~ ^https:// ]]; then
            echo "âŒ Error: Invalid URL format - must start with https://"
            echo "   Current: ${BASE_URL}"
            exit 1
          fi
          
          # Test URL construction by checking if it's a valid URL format
          if ! echo "${FULL_URL}" | grep -qE '^https?://[^[:space:]]+'; then
            echo "âŒ Error: Constructed URL appears malformed"
            echo "   Base: ${BASE_URL}"
            echo "   Query length: ${#QUERY}"
            exit 1
          fi
          
          # Make the request with redirect following and capture both response code and body
          # -L flag follows redirects, -s is silent, -o writes output, -w writes http_code
          # Use --url flag to explicitly specify URL (helps with malformed URL detection)
          # Run curl and capture exit code separately
          set +e  # Don't exit on error
          
          # Try to validate the URL first by checking curl's URL parsing
          echo "ğŸ” Testing URL construction..."
          curl --version > /dev/null 2>&1 || echo "âš ï¸  curl version check failed"
          
          HTTP_CODE=$(curl -L -s -o /tmp/response.txt -w "%{http_code}" \
            --url "${FULL_URL}" \
            -H "User-Agent: GitHub-Actions" \
            -H "X-Cron-Source: github-actions" \
            --max-time 60 \
            --show-error \
            2>&1)
          CURL_EXIT=$?
          set -e  # Re-enable exit on error
          
          # Check if curl command itself failed
          if [ "${CURL_EXIT}" -ne 0 ]; then
            echo "âŒ curl command failed with exit code: ${CURL_EXIT}"
            echo "ğŸ“„ curl output: ${HTTP_CODE}"
            if [ -f /tmp/response.txt ]; then
              echo "ğŸ“„ Response body:"
              cat /tmp/response.txt
            fi
            echo "ğŸ’¡ This might indicate:"
            echo "   - Network connectivity issue"
            echo "   - Malformed URL"
            echo "   - DNS resolution failure"
            echo "   - SSL/TLS certificate issue"
            exit 1
          fi
          
          # Ensure HTTP_CODE is set and is numeric
          if [ -z "${HTTP_CODE}" ] || ! [[ "${HTTP_CODE}" =~ ^[0-9]+$ ]]; then
            echo "âŒ Failed to get valid HTTP response code"
            echo "ğŸ“„ curl output: ${HTTP_CODE}"
            if [ -f /tmp/response.txt ]; then
              echo "ğŸ“„ Response body:"
              cat /tmp/response.txt
            fi
            exit 1
          fi
          
          echo "ğŸ“Š Response code: ${HTTP_CODE}"
          
          if [ -f /tmp/response.txt ]; then
            # Check if response is HTML (Vercel protection page)
            if head -1 /tmp/response.txt | grep -q "<!doctype html"; then
              echo "âŒ Got HTML response - Vercel Deployment Protection is blocking the request"
              echo "ğŸ“„ Response preview (first 500 chars):"
              head -c 500 /tmp/response.txt
              echo ""
              echo ""
              echo "ğŸ’¡ Solution: Add VERCEL_BYPASS_TOKEN to GitHub Secrets"
              echo "   1. Go to Vercel Dashboard â†’ Your Project â†’ Settings â†’ Security"
              echo "   2. Create a Protection Bypass Token"
              echo "   3. Add it to GitHub Secrets as VERCEL_BYPASS_TOKEN"
            else
              echo "ğŸ“„ Response body:"
              cat /tmp/response.txt
              echo ""
            fi
          fi
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Newsletter cron triggered successfully"
            exit 0
          elif [ "$HTTP_CODE" -eq 307 ] || [ "$HTTP_CODE" -eq 301 ] || [ "$HTTP_CODE" -eq 302 ]; then
            echo "âŒ Got redirect (${HTTP_CODE}) - URL might be incorrect or missing protocol"
            echo "ğŸ’¡ Verify VERCEL_URL is correct:"
            echo "   - Should be: https://your-domain.vercel.app"
            echo "   - Current: ${VERCEL_URL}"
            echo "   - Check if the domain is correct and deployment is live"
            exit 1
          elif [ "$HTTP_CODE" -eq 401 ]; then
            echo "âŒ Authentication failed (401)"
            if [ -z "${VERCEL_BYPASS_TOKEN}" ]; then
              echo "ğŸ’¡ This is likely due to Vercel Deployment Protection"
              echo "   Add VERCEL_BYPASS_TOKEN to GitHub Secrets to fix this"
            else
              echo "ğŸ’¡ Bypass token is set but still getting 401"
              echo "   Verify the token is correct in Vercel Dashboard"
            fi
            exit 1
          elif [ "$HTTP_CODE" -eq 0 ] || [ -z "$HTTP_CODE" ]; then
            echo "âŒ Error: Failed to connect to ${VERCEL_URL}"
            echo "Please verify:"
            echo "  1. VERCEL_URL is correct (should be https://your-domain.vercel.app)"
            echo "  2. The site is deployed and accessible"
            echo "  3. There are no network/firewall issues"
            exit 1
          else
            echo "âŒ Newsletter cron failed with HTTP status: ${HTTP_CODE}"
            echo "Check the response body above for error details"
            exit 1
          fi

